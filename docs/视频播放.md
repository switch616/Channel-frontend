# 基于vue-plyr的视频播放组件技术解析
该组件是基于 `vue-plyr` 封装的高性能视频播放组件，核心实现视频封面背景模糊、视频自适应缩放+工具栏固定布局，同时集成多分辨率切换、播放行为上报、播放速度控制等增强功能，以下是核心技术点解析：

## 一、核心功能实现
### 1. 视频播放背景模糊效果
#### 实现思路
通过「独立模糊封面层 + 滤镜处理 + 加载完成自动隐藏」的方式实现，避免直接对视频动态内容加模糊导致性能损耗。

#### 关键代码与解析
- **结构层**：独立的绝对定位封面容器，仅在视频未加载完成时显示
  ```html
  <div v-if="poster && showPosterOverlay" class="poster-overlay" :style="{ backgroundImage: `url(${poster})` }"></div>
  ```
- **样式层**：滤镜+视觉优化，解决模糊边缘空白问题
  ```css
  .poster-overlay {
    position: absolute;
    inset: 0; /* 全屏覆盖父容器 */
    background-size: cover; /* 封面图铺满容器 */
    background-position: center; /* 封面居中 */
    /* 核心模糊效果，搭配亮度/饱和度优化视觉 */
    filter: blur(28px) brightness(0.9) saturate(1.1);
    /* 轻微放大避免模糊后边缘空白 */
    transform: scale(1.05);
    transform-origin: center;
    z-index: 1; /* 低于视频容器，仅作为背景 */
  }
  ```
- **逻辑层**：监听视频可播放事件，自动隐藏模糊层
  ```typescript
  const showPosterOverlay = ref(true)
  const onCanPlay = () => {
    showPosterOverlay.value = false // 视频加载完成后隐藏模糊背景
  }
  ```

#### 技术亮点
- 性能优化：模糊效果仅作用于静态封面图，而非动态视频流，降低浏览器渲染压力；
- 视觉体验：通过 `scale(1.05)` 解决模糊滤镜导致的边缘空白问题，`brightness/saturate` 优化模糊后的色彩表现；
- 状态控制：精准监听 `canplay` 事件，确保视频可播放时无缝隐藏模糊层，无视觉断层。

### 2. 画布固定宽高下的视频自适应+工具栏固定布局
#### 实现思路
将视频容器设为固定宽高，视频内容通过 `object-fit` 自适应缩放保持比例，工具栏基于容器绝对定位，不随视频内容缩放。

#### 关键代码与解析
- **基础布局**：固定宽高的根容器，作为所有子元素的定位参考
  ```css
  .plyr-host {
    width: 100%;
    height: 100%;
    position: relative;
  }
  ```
- **视频自适应缩放**：核心使用 `object-fit: contain` 保持比例
  ```css
  ::v-deep(video) {
    width: 100%;
    height: 100%;
    object-fit: contain; /* 保持视频宽高比，自适应填充容器 */
    background: transparent !important;
  }
  ```
- **工具栏固定布局**：基于容器定位，不受视频缩放影响
  ```css
  ::v-deep(.plyr) {
    width: 100%;
    height: 100%;
    position: relative; /* 工具栏定位参考 */
    z-index: 2; /* 高于模糊层 */
    background: transparent;
  }
  ::v-deep(.plyr__video-wrapper) {
    height: 100%;
    background: transparent !important;
  }
  ```

#### 技术亮点
- 自适应兼容：`object-fit: contain` 适配所有分辨率视频，确保视频内容完整显示且不拉伸变形；
- 布局稳定性：工具栏基于外层容器（而非视频内容）绝对定位，无论视频如何缩放，工具栏始终铺满容器宽度；
- 样式穿透：通过 `::v-deep` 穿透 Vue 作用域样式，精准修改 `vue-plyr` 内部组件样式，不污染全局。

## 二、其他技术亮点
### 1. 播放行为上报（防重复）
```typescript
const hasReported = ref(false)
const onPlay = async () => {
  if (!hasReported.value && props.videoId) {
    try {
      await logVideoView({ video_id: props.videoId })
      hasReported.value = true // 标记已上报，避免重复请求
    } catch (e) {}
  }
}
```
- 防抖设计：通过 `hasReported` 状态标记，确保同一视频仅上报一次播放行为；
- 异常处理：捕获接口请求异常，避免上报失败导致视频播放中断。

### 2. 多分辨率+播放速度自定义配置
```typescript
const plyrOptions = {
  controls: ['play-large', 'play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
  settings: ['quality', 'speed'], // 开启分辨率/速度设置项
  speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] }, // 自定义播放速度
  quality: { default: 720, options: [1080, 720] }, // 自定义分辨率选项
  i18n: { qualityLabel: { 1080: '1080P', 720: '720P' } }, // 分辨率文案本地化
}
```
- 本地化适配：自定义分辨率显示文案，符合中文用户习惯；
- 体验优化：预设常用播放速度/分辨率，减少用户操作成本；
- 灵活扩展：通过 `source` 标签动态渲染多分辨率视频源，支持无缝切换。

### 3. 视频加载优化
```html
<video
  :poster="poster"
  playsinline
  :autoplay="autoplay"
  preload="metadata"
  controls
>
```
- `preload="metadata"`：仅预加载视频元数据（时长、分辨率等），不加载完整视频流，减少首屏加载耗时；
- `playsinline`：适配移动端播放，避免自动全屏，提升移动端体验；
- 原生封面：绑定 `poster` 属性，确保视频加载前显示原生封面，与模糊背景层呼应。

## 三、核心技术总结
| 功能点                | 核心实现方案                          | 技术优势                     |
|-----------------------|---------------------------------------|------------------------------|
| 视频背景模糊          | 静态封面层 + filter: blur + 加载隐藏  | 性能优、视觉过渡自然        |
| 视频自适应缩放        | video 标签 + object-fit: contain      | 适配所有分辨率、无拉伸变形   |
| 工具栏固定布局        | 基于容器绝对定位 + 样式穿透           | 布局稳定、不受视频缩放影响   |
| 播放行为上报          | 状态标记 + 异常捕获                   | 防重复、鲁棒性强            |
| 多分辨率/速度控制     | plyr 配置 + 动态 source 渲染          | 配置灵活、用户体验佳        |
| 加载优化              | preload="metadata" + playsinline      | 首屏快、移动端适配好        |